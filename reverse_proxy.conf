example.com {
    # TLS配置
    tls {
        protocols tls1.2 tls1.3
    }

    # 完整安全头部
    header {
        Strict-Transport-Security "max-age=31536000; preload; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server

        # 新增安全头部
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-Permitted-Cross-Domain-Policies "none"
    }

    # 启用压缩
    encode gzip

    # 完整日志配置
    log {
        output file /var/log/caddy/example.com.access.log {
            roll_size 100mb
            roll_keep 30
            roll_local_time
        }
        format json
    }

    # 错误日志配置
    log {
        output file /var/log/caddy/example.com.error.log {
            roll_size 50mb
            roll_keep 30
            roll_local_time
        }
        format json
        level ERROR
    }

    # 完整反向代理配置
    reverse_proxy http://localhost:8080 {
        header_up Host {host}
        header_up X-Real-IP {remote.host}
        header_up X-Forwarded-For {remote.host}
        header_up X-Forwarded-Proto {scheme}
    }

    # 安全缓存配置 - 静态文件
    @static {
        path /static/*
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # HTML页面缓存配置
    @html {
        path *.html
    }
    header @html Cache-Control "public, max-age=3600, must-revalidate"

    # JSON/XML文件缓存配置
    @json_xml {
        path /api/*.json
        path /api/*.xml
    }
    header @json_xml Cache-Control "public, max-age=1800, must-revalidate"

    # API路径的额外安全配置
    @api_paths {
        path /api/*
        path /admin/*
        path /login/*
        path /register/*
    }

    # 对API路径应用严格缓存控制
    header @api_paths {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }

    # 简化错误处理 - 仅处理500错误
    handle_errors {
        @5xx expression {err.status_code} >= 500
        handle @5xx {
            respond "服务暂时不可用，请稍后重试" 503
        }
    }
}
