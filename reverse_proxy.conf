example.com {
    # TLS 配置
    tls {
        protocols tls1.2 tls1.3
    }

    # -----------------------------
    # 安全头部（兼容绝大多数前端）
    # -----------------------------
    header {
        Strict-Transport-Security "max-age=31536000; preload; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server

        # CSP 兼容绝大多数前端资源加载
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' ws: wss: https:; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"

        Permissions-Policy "camera=(), microphone=(), geolocation=()"
        X-Permitted-Cross-Domain-Policies "none"
    }

    # -----------------------------
    # 压缩
    # -----------------------------
    encode gzip

    # -----------------------------
    # 日志
    # -----------------------------
    log {
        output file /var/log/caddy/example.com.access.log {
            roll_size 100mb
            roll_keep 30
            roll_local_time
        }
        format json
    }

    log {
        output file /var/log/caddy/example.com.error.log {
            roll_size 50mb
            roll_keep 30
            roll_local_time
        }
        format json
        level ERROR
    }

    # -----------------------------
    # 反向代理（所有请求）
    # -----------------------------
    reverse_proxy http://localhost:8080 {
        transport http {
            versions 1.1
        }
        header_up Host {host}
        header_up X-Real-IP {remote.host}
        header_up X-Forwarded-For {remote.host}
        header_up X-Forwarded-Proto {scheme}
    }

    # -----------------------------
    # 缓存策略
    # -----------------------------
    # 静态资源（js/css/img/font）长期缓存
    @static {
        path /static/*
        path *.js
        path *.css
        path *.png
        path *.jpg
        path *.jpeg
        path *.svg
        path *.gif
        path *.woff
        path *.woff2
        path *.ttf
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # HTML 页面短期缓存
    @html {
        path *.html
    }
    header @html Cache-Control "public, max-age=3600, must-revalidate"

    # API 路径严格禁止缓存
    @api_paths {
        path /api/*
        path /admin/*
        path /login/*
        path /register/*
    }
    header @api_paths {
        Cache-Control "no-cache, no-store, must-revalidate"
        Pragma "no-cache"
        Expires "0"
    }

    # JSON/XML 文件中期缓存
    @json_xml {
        path *.json
        path *.xml
    }
    header @json_xml Cache-Control "public, max-age=1800, must-revalidate"

    # -----------------------------
    # 错误处理
    # -----------------------------
    handle_errors {
        @5xx expression {err.status_code} >= 500
        handle @5xx {
            respond "服务暂时不可用，请稍后重试" 503
        }
    }

    # -----------------------------
    # 可选安全强化（注释）
    # -----------------------------
    # # IP 白名单示例
    # @allowed_ip {
    #     remote_ip 123.123.123.123/32
    # }
    # respond @allowed_ip "Forbidden" 403

    # # 防暴力破解示例
    # rate_limit {
    #     zone default {
    #         period 1m
    #         burst 5
    #     }
    #     match @api_paths
    #     reject 429
    # }
}
