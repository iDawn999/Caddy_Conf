example.com {

    # TLS（显式写出，仅用于可读性）
    tls {
        protocols tls1.2 tls1.3
    }

    # ========================
    # 根目录
    # ========================
    root * /data/caddy/sites/example.com

    # ========================
    # 安全头部
    # ========================
    header {
        Strict-Transport-Security "max-age=31536000; preload; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
        X-Permitted-Cross-Domain-Policies "none"
        X-Download-Options "noopen"
        X-DNS-Prefetch-Control "off"

        Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"

        -Server
        -X-Powered-By
    }

    # ========================
    # 压缩
    # ========================
    encode gzip

    # ========================
    # 访问日志（唯一 log 块）
    # ========================
    log {
        output file /var/log/caddy/example.com.access.log {
            roll_size 100mb
            roll_keep 30
            roll_local_time
        }
        format json
        level INFO
    }

    # ========================
    # 静态文件服务
    # ========================
    file_server {
        index index.html index.htm
        hide .git .gitignore .svn .hg
        hide README.md LICENSE TODO.md CHANGELOG.md
        hide .env .htaccess .htpasswd .DS_Store
        hide *.key *.pem *.p12 *.pfx *.crt *.csr
        hide web.config nginx.conf apache.conf
        hide *.log *.sql *.dump *.backup
        hide config.php config.json config.yaml
        hide wp-config.php
        hide admin panel panels
        hide *.bak *~ *.tmp
    }

    # ========================
    # 缓存策略
    # ========================

    @static_assets {
        path /static/*
    }
    header @static_assets Cache-Control "public, max-age=31536000, immutable, no-transform"

    @fonts {
        path *.woff *.woff2 *.ttf *.otf *.eot
    }
    header @fonts Cache-Control "public, max-age=31536000, immutable"

    @images {
        path *.png *.jpg *.jpeg *.gif *.svg *.webp *.ico
    }
    header @images Cache-Control "public, max-age=2592000, immutable"

    @assets {
        path *.css *.js
    }
    header @assets Cache-Control "public, max-age=86400, must-revalidate"

    @html {
        path *.html
    }
    header @html Cache-Control "public, max-age=3600, must-revalidate"

    @data {
        path *.json *.xml *.csv *.txt
    }
    header @data Cache-Control "public, max-age=1800, must-revalidate"

    # ========================
    # 错误处理
    # ========================
    handle_errors {

        @404 expression {err.status_code} == 404
        handle @404 {
            respond "页面未找到" 404
        }

        @403 expression {err.status_code} == 403
        handle @403 {
            respond "访问被拒绝" 403
        }

        @5xx expression {err.status_code} >= 500
        handle @5xx {
            respond "服务器内部错误" 500
        }

        handle {
            respond "请求错误" 400
        }
    }
}
