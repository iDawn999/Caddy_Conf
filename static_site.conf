example.com {
    # TLS配置 - 生产级安全
    tls {
        protocols tls1.2 tls1.3
        ciphers TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384 TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305 TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        curves x25519 p256 p384
    }
    
    # 生产级安全头部
    header {
        Strict-Transport-Security "max-age=31536000; preload; includeSubDomains; always"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
        -X-Powered-By
        
        # 严格的内容安全策略
        Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
        Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"
        X-Permitted-Cross-Domain-Policies "none"
        
        # 额外安全头部
        X-Download-Options "noopen"
        X-DNS-Prefetch-Control "off"
    }

    # 生产级压缩配置
    encode gzip minimum_length 1024

    # 生产级日志配置
    log {
        output file /var/log/caddy/example.com.access.log {
            roll_size 100mb
            roll_keep 30
            roll_local_time
        }
        format json
        include ip user_agent protocol method uri status size duration
    }

    # 错误日志配置
    log {
        output file /var/log/caddy/example.com.error.log {
            roll_size 50mb
            roll_keep 30
            roll_local_time
        }
        format json
        level ERROR
    }

    # 生产级静态文件服务器
    file_server {
        root /data/caddy/sites/example.com
        index index.html index.htm
        
        # 生产环境关闭目录浏览
        # browse
        
        # 隐藏所有敏感文件和目录
        hide .git .gitignore .svn .hg
        hide README.md LICENSE TODO.md CHANGELOG.md
        hide .env .htaccess .htpasswd .DS_Store
        hide *.key *.pem *.p12 *.pfx *.crt *.csr
        hide web.config nginx.conf apache.conf
        hide *.log *.sql *.dump *.backup
        hide config.php config.json config.yaml
        hide wp-config.php
        hide admin panel panels
        
        # 防止访问备份文件
        hide *.bak *~ *.tmp
        
        # MIME类型自动识别（移除手动映射，使用Caddy内置）
    }

    # 生产级缓存策略
    
    # 静态资源：永久缓存
    @static_assets {
        path /static/*
    }
    header @static_assets Cache-Control "public, max-age=31536000, immutable, no-transform"
    
    # 字体文件：永久缓存
    @fonts {
        path *.woff
        path *.woff2
        path *.ttf
        path *.otf
        path *.eot
    }
    header @fonts Cache-Control "public, max-age=31536000, immutable"
    
    # 图片文件：长期缓存
    @images {
        path *.png
        path *.jpg
        path *.jpeg
        path *.gif
        path *.svg
        path *.webp
        path *.ico
    }
    header @images Cache-Control "public, max-age=2592000, immutable"  # 30天
    
    # CSS/JS文件：中等缓存
    @assets {
        path *.css
        path *.js
    }
    header @assets Cache-Control "public, max-age=86400, must-revalidate"
    
    # HTML文件：短期缓存
    @html {
        path *.html
    }
    header @html Cache-Control "public, max-age=3600, must-revalidate"
    
    # 数据文件：短期缓存
    @data {
        path *.json
        path *.xml
        path *.csv
        path *.txt
    }
    header @data Cache-Control "public, max-age=1800, must-revalidate"

    # 生产级错误处理
    handle_errors {
        @404 expression {err.status_code} == 404
        handle @404 {
            respond @404 "页面未找到" 404
        }
        
        @403 expression {err.status_code} == 403
        handle @403 {
            respond @403 "访问被拒绝" 403
        }
        
        @5xx expression {err.status_code} >= 500
        handle @5xx {
            respond @5xx "服务器内部错误" 500
        }
        
        @4xx expression {err.status_code} >= 400
        handle @4xx {
            respond @4xx "请求错误" 400
        }
    }
}
